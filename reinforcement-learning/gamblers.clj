;; Gambler's Problem

(defn abs[x] (if (< x 0) (- x) x))
(map abs (range -5 5)) ; (5 4 3 2 1 0 1 2 3 4)

(defn linfinity [v1 v2]
  (assert (= (count v1) (count v2)))
  (reduce max (map abs (map - v1 v2))))

(linfinity [0 2 3] [0 -2 3])

  

;; We got states 0..100, let's take initial values 0

;; everything is worthless
(def v0 (vec (repeat 101 0 )))

v0 ; [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]

(defn update [v, n, stake]
  (if (#{0,100} n) 0 
      (let [win  (+ n stake)
            loss (- n stake)]
        (assert (and (<= 0 loss) (<= win 100)))
        (cond (and (< 0 loss) (< win 100))
              (+ (* 0.4 (v win)) (* 0.6 (v loss)))
              (= 0 loss)
              (+ (* 0.4 (v win)) (* 0.6 (v loss)))
              (= 100 win)
              (+ (* 0.4 (+ 1 (v win))) (* 0.6 (v loss)))
              :else :fuuuck))))


(update v0 100 0) ; 0 
(update v0 99  0) ; 0.0
(update v0 99  1) ; 0.4
(update v0 98  0) ; 0.0
(update v0 98  1) ; 0.0
(update v0 98  2) ; 0.4


;; always bet one
(def pi0 (vec (repeat 101 1)))

pi0 ; [1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1]

(defn updater [policy]
  (fn [v n] (assoc v n (update v n (policy n)))))

(def v01 (reduce (updater policy) v0 (range 0 101)))

v01 ; [0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.4 0]

(def v02 (reduce (updater policy) v01 (range 0 101)))

v02 ; [0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.16000000000000003 0.49600000000000005 0]

(defn jacobi [v pi] (reduce (updater pi) v (range 0 101)))

((fn[v] (jacobi v pi0)) v0)

(take 10 (map first (iterate (fn[v] (jacobi v pi0)) v0)))

(def v0series (iterate (fn[v] (jacobi v pi0)) v0))

(take 10 v0series) ;  ;

(def v0shifts (map linfinity v0series (drop 1 v0series)))

(count (take-while (fn[x] (> (abs x) 0.000001)) v0shifts))

(def v2 (nth vseries 141))

v2 ; [0 2.4273434576787555E-24 8.175524612983307E-24 2.2398345687917716E-23 5.768247682621185E-23 1.4430935591880815E-22 3.540122278524833E-22 8.54133464263185E-22 2.0292419365566994E-21 4.750273818338088E-21 1.0961719084860009E-20 2.4945038640078527E-20 5.60005958062417E-20 1.240662750887747E-19 2.7133833979093295E-19 5.860078198698961E-19 1.2501561189551955E-18 2.6352573664989602E-18 5.4904127232993695E-18 1.1309189233466478E-17 2.3036695723033188E-17 4.641789439930633E-17 9.254187966130524E-17 1.8259417453679124E-16 3.566453103877571E-16 6.897469083224675E-16 1.3211339116388588E-15 2.5067189790694715E-15 4.712614943031388E-15 8.780303982972835E-15 1.6215875476433115E-14 2.969236448947383E-14 5.39152267282683E-14 9.71018908626566E-14 1.734920531913113E-13 3.0757570965368266E-13 5.411640066531992E-13 9.451335031392587E-13 1.6388038392846905E-12 2.8217065144875944E-12 4.825348503886713E-12 8.197057087672974E-12 1.3835018646590173E-11 2.3204587879988175E-11 3.86829787427514E-11 6.410581172303925E-11 1.056296428710561E-10 1.7308706951630587E-10 2.8210670931785754E-10 4.5741654761621467E-10 7.379719156370073E-10 1.1848880191025594E-9 1.8936707124499222E-9 3.0130172395139293E-9 4.773634958656561E-9 7.532302026659245E-9 1.1839072088773641E-8 1.8539559276764747E-8 2.8930311703261378E-8 4.4994413626146046E-8 6.975818241718161E-8 1.0783044721072254E-7 1.6621686256069384E-7 2.555481983303993E-7 3.91931318804831E-7 5.997362614377226E-7 9.157899087031517E-7 1.3956824014083047E-6 2.1232459427609874E-6 3.224795894185334E-6 4.8905194149830185E-6 7.406589860907367E-6 1.1203374487425602E-5 1.6927786820330453E-5 2.55518605189989E-5 3.8535659384426925E-5 5.807169440910839E-5 8.745160248326721E-5 1.3161621611455025E-4 1.9798071458407588E-4 2.976723872654547E-4 4.4738729871439734E-4 6.721752815717196E-4 0.0010096173857473217 0.0015160919633938727 0.0022761736427561875 0.0034167315509625318 0.005128076302505346 0.00769568000099849 0.011547755593507973 0.017326625049444745 0.02599577052991281 0.039000409748957465 0.05850835727611829 0.08777131434633881 0.1316668009632 0.1975110509066895 0.29627835049059426 0.44443004226230487 0.6666580253573829 0]

(update v1 100 0) ; 0 

(update v1 99  0) ; 0.4 
(update v1 99  1) ; 0.4 

(update v1 98  0) ; 0.0 
(update v1 98  1) ; 0.16000000000000003
(update v1 98  2) ; 0.4

(update v1 97  0) ; 0.0
(update v1 97  1) ; 0.0
(update v1 97  2) ; 0.16000000000000003
(update v1 97  3) ; 0.4

(defn available-actions [s]
  (range (inc (min s (- 100 s)))))

(available-actions 99)
(available-actions 97)


(sort
 (for [a (available-actions 97)] [(update v1 97 a) a])) ; ([0.0 0] [0.0 1] [0.16000000000000003 2] [0.4 3])

(second (last (sort
               (for [a (available-actions 97)] [(update v1 97 a) a])))) ; 3

(defn sorted-actions [v n]
  (reverse (sort
   (for [a (available-actions n)] [(update v n a) a]))))

(defn optimal-action [v n]
  (second (first (sorted-actions v n))))


(sorted-actions v1 100) ; ([0 0])
(sorted-actions v1 99) ; ([0.4 1] [0.4 0]) ; ([0.4 0] [0.4 1])
(sorted-actions v1 50) ; ([0.16000000000000003 49] [0.0 50] [0.0 48] [0.0 47] [0.0 46] [0.0 45] [0.0 44] [0.0 43] [0.0 42] [0.0 41] [0.0 40] [0.0 39] [0.0 38] [0.0 37] [0.0 36] [0.0 35] [0.0 34] [0.0 33] [0.0 32] [0.0 31] [0.0 30] [0.0 29] [0.0 28] [0.0 27] [0.0 26] [0.0 25] [0.0 24] [0.0 23] [0.0 22] [0.0 21] [0.0 20] [0.0 19] [0.0 18] [0.0 17] [0.0 16] [0.0 15] [0.0 14] [0.0 13] [0.0 12] [0.0 11] [0.0 10] [0.0 9] [0.0 8] [0.0 7] [0.0 6] [0.0 5] [0.0 4] [0.0 3] [0.0 2] [0.0 1] [0.0 0])

(optimal-action v1 100) ; 0
(optimal-action v1 99) ; 1
(optimal-action v1 50) ; 49

(def pi1 (mapv (fn [n] (optimal-action v1 n)) (range 101)))

pi1 ; [0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 49 49 48 47 46 45 44 43 42 41 40 39 38 37 36 35 34 33 32 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0]


(defn value-update [v n]
  (update v n (optimal-action v n)))

(value-update v0 0) ; 0
(value-update v0 1) ; 0.0
(value-update v0 2) ; 0.0

(map (fn [n] (value-update v0 n)) (range 0 101)) ; (0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0)

(defn value-iterate [v]
  (mapv (fn [n] (value-update v n)) (range 0 101)))

(def vv (value-iterate v0)) ; #'boot.user/vv
vv ; [0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0]
(def vvv (value-iterate vv)) ; #'boot.user/vvv
vvv ; [0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.16000000000000003 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.4 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0.64 0]

(def vvseries (iterate value-iterate v0))

(def vvshifts (map linfinity vvseries (drop 1 vvseries)))


(count (take-while (fn[x] (> (abs x) 0.000000000000000000000000000001)) vvshifts)) ; 57 ; 57 ; 56 ; 39

(def optv (nth vvseries 57)) ; [0 0.002065624776544316 0.00516406194136079 0.00922547106779389 0.012910154853401974 0.017385398981324286 0.023063677669484722 0.02781411305627054 0.03227538713350493 0.037685072795366426 0.04346349745331071 0.05035446998069343 0.057659194173711806 0.06523937486592661 0.06953528264067635 0.07443123938879458 0.08068846783376232 0.08661104367721989 0.09421268198841606 0.10314362491955596 0.10865874363327677 0.11596662620633194 0.12588617495173357 0.13357997572379918 0.1441479854342795 0.15478902470271128 0.1630984371648165 0.16774609291204123 0.17383820660169086 0.17936523228010298 0.18607809847198645 0.19459551650422713 0.2017211695844058 0.20841308070025744 0.2165276091930497 0.22519524617996606 0.23553170497104015 0.24648879126056772 0.2578590622988899 0.26430292396101457 0.27164685908319186 0.2810327017506435 0.28991656551582984 0.30131902298262414 0.31471543737933394 0.3229881154499151 0.3339499393094979 0.3488292624276004 0.3603699635856987 0.37622197815141933 0.3869725617567782 0.40309843716481647 0.4077460929120412 0.41383820660169085 0.41936523228010303 0.42607809847198647 0.4345955165042271 0.4417211695844058 0.4484130807002574 0.4565276091930497 0.4651952461799661 0.47553170497104014 0.48648879126056777 0.49785906229888993 0.5043029239610145 0.5116468590831919 0.5210327017506435 0.5299165655158298 0.5413190229826241 0.5547154373793339 0.5629881154499151 0.5739499393094979 0.5888292624276004 0.6003699635856987 0.6162219781514192 0.6321835370540669 0.6446476557472247 0.6516191393680618 0.6607573099025363 0.6690478484201545 0.6791171477079796 0.6918932747563407 0.7025817543766086 0.7126196210503861 0.7247914137895746 0.7377928692699491 0.7532975574565602 0.7697331868908515 0.7867885934483348 0.7964543859415218 0.8074702886247878 0.8215490526259652 0.8348748482737447 0.8519785344739361 0.8720731560690009 0.8844821731748727 0.9009249089642468 0.9232438936414006 0.9405549453785482 0.9643329672271289 0]

(def pi-optimal (mapv (fn [n] (optimal-action optv n)) (range 101)))

pi-optimal ; [0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 0 21 22 23 24 25 26 27 28 29 30 31 32 33 0 35 36 0 38 39 40 41 42 43 44 45 46 47 48 49 1 49 48 47 0 45 44 43 42 41 40 39 0 37 36 35 34 33 32 31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16 15 14 13 12 11 10 9 8 7 6 5 4 3 0 1 0]

(sorted-actions optv 20) ; ([0.10865874363327677 0] [0.10865874363327675 20] [0.10827282543426636 1] [0.10696054445033243 19] [0.10696054445033243 6] [0.10688207917374307 2] [0.10657435351436126 5] [0.10624206208437245 7] [0.10624206208437244 18] [0.1060722748739692 4] [0.10539861649585161 3] [0.10413079914490343 17] [0.10413079914490343 8] [0.10195877490045725 16] [0.10195877490045724 9] [0.100509337860781 15] [0.100509337860781 10] [0.10044925027891072 14] [0.10044925027891072 11] [0.1000537001138653 13] [0.10005370011386527 12])
(optv 20) ; 0.10865874363327677
