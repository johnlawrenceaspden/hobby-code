;; Discounted Present Value

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; A bird in the hand is worth two in the bush

;; A pound in a year's time is worth less than a pound now

;; Suppose you'd pay 50p now for the guarantee of £1 in a year

;; We'd say that you had a discount factor of 1/2

;; What's a constant guaranteed stream of one pound a year worth?

;; One way to look at it is that, whatever it is worth, call it S, it's also worth a pound now plus the
;; guarantee of a constant stream of pounds starting in a year's time.

;; And that's worth 1/2 what it is now, so S = 1 + S/2, so S = 2

;; Another way of looking at is is that a pound in two years time is worth 1/2 pound in one year's
;; time, which is worth 1/4 pound now, and so on

;; As every schoolboy knows, 1 + 1/2 + 1/4 + 1/8 + 1/16 + ..... = 2

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; We may generalize a little:

;; The discounted present value (with discount factor gamma) of a finite sequence is defined to be:
(defn dpv-definition [gamma sq]
  (reduce + (map *
                 (iterate #(* gamma %) 1)
                 sq)))

;; If your discount value is one, then the discounted present value of a finite sequence is just its sum:
(dpv-definition 1  [1]) ; 1
(dpv-definition 1  [1 1]) ; 2
(dpv-definition 1  [1 1 1 1]) ; 4

;; And I would like to talk to you about some very safe investments which you can make, and I would be happy to save you the paperwork
;; involved in investing in them.


;; If your discount value is 1/2
(dpv-definition 1/2  [1]) ; 1
(dpv-definition 1/2  [1 1]) ; 3/2
(dpv-definition 1/2  [1 1 1]) ; 7/4
(dpv-definition 1/2  [1 1 1 1]) ; 15/8
(dpv-definition 1/2  [1 1 1 1 1 1 1 1 1 1 1 1 1 1 ]) ; 16383/8192

;; Then you are a very short term thinker, and I would like to offer you £2 in return for your
;; guarantee to give me a pound every year from now until the crack of doom


;; fractions are fiddly to read
(defn twosf   [x]  (float (/ (Math/round (* x 100.0)) 100)))

(twosf (dpv-definition 1/2  [1 1 1 1 1 1 1 1 1 1])) ; 2.0

;; It is more reasonable to take a discount value somewhere in between. 
;; Persons taking discount factors of 1% year, (gamma = 99/100) take a long term view

(twosf (dpv-definition 99/100  [1])) ; 1.0
(twosf (dpv-definition 99/100  [1 1])) ; 1.99
(twosf (dpv-definition 99/100  [1 1 1 1])) ; 3.94
(twosf (dpv-definition 99/100  (repeat 100 1))) ; 63.4
(twosf (dpv-definition 99/100  (repeat 200 1))) ; 86.6
(twosf (dpv-definition 99/100  (repeat 300 1))) ; 95.1
(twosf (dpv-definition 99/100  (repeat 400 1))) ; 98.2
(twosf (dpv-definition 99/100  (repeat 800 1))) ; 99.97
(twosf (dpv-definition 99/100  (repeat 900 1))) ; 99.99
(twosf (dpv-definition 99/100  (repeat 1000 1))) ; 100.0

;; But even to them, a thousand years is as good as forever.

;; Of course, the discounted sequences don't have to be constant
(dpv-definition 1/2  [1 2 3 5 7 11]) ; 133/32


;; Notice that dpv of a sequence satisfies a nice recurrence relation with the dpv of its tail
(dpv-definition 1/2  [1 2 3 5 7 11]) ; 133/32
(+ 1 (* 1/2 (dpv-definition 1/2  [2 3 5 7 11]))) ; 133/32
(dpv-definition 1/2  [2 3 5 7 11]) ; 101/16
(+ 2 (* 1/2 (dpv-definition 1/2  [3 5 7 11]))) ; 101/16
(dpv-definition 1/2  [3 5 7 11]) ; 69/8
(+ 3 (* 1/2 (dpv-definition 1/2  [5 7 11]))) ; 69/8
(dpv-definition 1/2  [5 7 11]) ; 45/4
(+ 5 (* 1/2 (dpv-definition 1/2  [7 11]))) ; 45/4
(dpv-definition 1/2  [7 11]) ; 25/2
(+ 7 (* 1/2 (dpv-definition 1/2  [11]))) ; 45/4
(dpv-definition 1/2  [11]) ; 11
(+ 11 (* 1/2 (dpv-definition 1/2  []))) ; 11N
(dpv-definition 1/2  []) ; 0

;; Another natural definition of dpv is by a recursive relation

;; It's worth whatever it's worth immediately, plus gamma times whatever it is worth next year:
(defn dpv-recur [gamma sq]
  (if (empty? sq) 0
      (+ (first sq) (* gamma (dpv-recur gamma (rest sq)))))) ; #'user/dpv-recur

(dpv-recur 1 [1]) ; 1
(dpv-recur 1/2 [1 1 1 1]) ; 15/8 
(twosf (dpv-recur 99/100  (repeat 100 1))) ; 63.4
(twosf (dpv-recur 99/100  (repeat 200 1))) ; 86.6

;; gloriously, these definitions agree
(- (dpv-recur      99/100  (repeat 200 1))
   (dpv-definition 99/100  (repeat 200 1))) ; 0N

;; Sadly this is not a tail recursion and so has a way of blowing stack!

;; But if we're happy to add up from the other end, we can keep the values in an accumulator and iterate
(defn reverse-dpv-iteration [gamma sq acc]
  (if (empty? sq) acc
      (recur gamma (rest sq) (+ (* gamma acc) (first sq)))))

;; and now we have an iterative definition
(defn dpv-it [gamma sq]
  (reverse-dpv-iteration gamma (reverse sq) 0))

(dpv-it 1/2 []) ; 0 
(dpv-it 1/2 [1]) ; 1N 
(dpv-it 1/2 [1 1]) ; 3/2 
(dpv-it 1/2 [1 1 1]) ; 7/4
(dpv-it 1/2 [0 1 1 1]) ; 7/8

(twosf (dpv-it 99/100  (repeat 100 1))) ; 63.4
(twosf (dpv-it 99/100  (repeat 200 1))) ; 86.6
(twosf (dpv-it 99/100  (repeat 300 1))) ; 95.1
(twosf (dpv-it 99/100  (repeat 400 1))) ; 98.2
(twosf (dpv-it 99/100  (repeat 500 1))) ; 99.34

;; But notice that this in fact gives us the dpv for all the tails, if we bother to record it
(defn reverse-dpvs-it [gamma sq acc sq2]
  (if (empty? sq) sq2
      (let [nacc (+ (* gamma acc) (first sq))]
        (recur gamma (rest sq) nacc (cons nacc sq2)))))

(dpv-definition 1/2  [1 2 3 5 7 11]) ; 133/32
(dpv-definition 1/2  [2 3 5 7 11]) ; 101/16
(dpv-definition 1/2  [3 5 7 11]) ; 69/8
(dpv-definition 1/2  [5 7 11]) ; 45/4
(dpv-definition 1/2  [7 11]) ; 25/2
(dpv-definition 1/2  [11]) ; 11
(dpv-definition 1/2  []) ; 0

(reverse-dpvs-it 1/2  (reverse [1 2 3 5 7 11]) 0 []) ; (133/32 101/16 69/8 45/4 25/2 11N)

(reverse-dpvs-it 1/2 (reverse []) 0 []) ; [] 
(reverse-dpvs-it 1/2 (reverse [1]) 0 []) ; (1N)
(reverse-dpvs-it 1/2 (reverse [1 1]) 0 []) ; (3/2 1N)
(reverse-dpvs-it 1/2 (reverse [1 1 1 1]) 0 []) ; (15/8 7/4 3/2 1N)

(reverse-dpvs-it 1/2 (reverse [0 1 1 1]) 0 []) ; (7/8 7/4 3/2 1N)
(reverse-dpvs-it 1/2 (reverse [0 0 1 1]) 0 []) ; (3/8 3/4 3/2 1N)
(reverse-dpvs-it 1/2 (reverse [0 0 0 1]) 0 []) ; (1/8 1/4 1/2 1N)
(reverse-dpvs-it 1/2 (reverse [0 0 0 0]) 0 []) ; (0N 0N 0N 0N)


;; a cleaner interface is always nice
(defn dpvs
  ([gamma sq] (reverse-dpvs-it gamma (reverse sq) 0 [])))

(dpvs 1/2 [0 0 0 0 1]) ; (1/16 1/8 1/4 1/2 1N)
(dpvs 1/2 [1 2 3 5 7 11]) ; (133/32 101/16 69/8 45/4 25/2 11N)

;; fiddly, as I say
(dpvs 99/100 (repeat 100 1)) ; (63396765872677049506938397342748261381028792336107630859404262730068295524927525181280345648997304959933843089934715672528176430319820058414289464550829242572610964993901729162885021780083239150509999/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 630270362350273227342812094371194559404331235718258897569740027576447429544722476578589349989871767272059021110451673459880570003230505640548378429806355985581928939332340698615000220000840799500101/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 6265357195457305326695071660315096559639709451699584823936767955317650803482045217965548989796684517899586071822744176362430000032631370106549277068751070561433625649821623218333335555564048479799/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 62276335307649548754495673336516126865047570219187725494310787427451018216990355737025747371683681998985717897199436124873030303359912829359083606755061318802359855048703264831649854096606550301/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 618952881895449987419148215520364917828763335547350762568795832600515335525155108454805529006905878777633514113125617422959902054140533629889733401566275947498584394431346109410604586834409599/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 6151039211065151388072204197175403210391548843912633965341372046469851873991465741967732616231372512905389031445713307302625273274146804342320539409760363106046307014458041509198026129640501/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 61121608192577286748204082799751547579712614584976100660013859055251029030216825676441743598296692049549384156017306134369952255294412165073944842522831950566124313277353954638363900299399/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 607288971642194815638425078785369167471844591767435360202160192477283121517341673499411551497946384338882668242599051862322750053478910758322675176998302530970952659367211663013776770701/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 6033221935779745612509344230155244115877218098660963234365254469467506277952946196963753045433801862008915840834333857195179293469483947053764395727255581120918713730981935990038149199/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 59931534704845915277872163940962061776537556552130941761265196661287942201544911080441949953876786484938543846811453102981609024944282293472367633608642233544633472030120565555940901/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 595268027321675911897698625666283452288258146991221633952173703649373153550958697782241918726028146312510543907186394979612212373174568620933006400087295288329631030607278439958999/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5911798255774504160582814400669529821093516636274965999516906097468415692433926240224665845717456023358692362698852474541537498718935036575080872728154497861915464955629075151101/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 58705032886611153137200145461308382031247642790656222217342485833014299923575012527521877229469252761198912754533863379207449482009444813889705785132873715776923888440697728799/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 582879120066779324618183287487963454861087300915719416336792786192063635591666793207291689186558108698978916712463266456640903858681260746360664496291653694716402913542401301/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5786657778452316410284679671595590453142295968845650670068614001940036723148149426336279688753112209080595118307709762188291958168497583296572368649410643380973766803458599/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 57440987661134509194794744157531216698407029988339905758268828302424613365132822488245249381344567768490859780885957193821130890590884679763357259084955993747209765691501/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 570110986476106153482775193510416330286939696851918239982513417196208215809422449376214640215601694631220805867534921149708392834251360401650073324090464583305149148399/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5657686732081880338209850439499154851383229261130487272550640577739476927367903529052673133490926208396169756237726476259680735699508690925758316404954187710153021701/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 56138249819008892305150004439385402539224537991217043157077177552924009367352560899521950843342688973698684406441681578380613491914229201270286024292466542526798199/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 556952018373827195001515196357428308477015535264818617748254318716404135023763241409312634781239282562612973802441228064450641332466961628992788124166328712391901/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5524767862361890858601163599569982913909247830957763815638932512286910454785487286962753886679184672349625998004456849135865063964312743727199880042084128407999/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 54795634973352432915163268682525079938477250817755190056958914265524348028136235221845998855345299720703292909135927769049142060245583269971715960021051802101/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 543390252256085180961245138207324039782598493108638283403625396621458060890265002240868675306518178997002958678140684535849919800460437070421373333545977799/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5387780325819042231931769072801252927096954475844831145491165622438970312022878810513825003096143222191949077556976611473231513135964010812337104379252301/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 53411922483020628605371404775770231586837923998432637833244097196353235474978573843573989930264072951433829066232086984578096092282464755680172771507599/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 529413358414349783892640452280507389766039636347804422558021183801547833080591654985595857881455282337715445113455424086647435275580452077577502742501/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5246599579942927110026671235156640300667067033816206288464860442439877101824158131167634928095507902401166112257125495824721568440206586642196997399/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 51985854342857849596229002375319598996637040745618245338028893357978556584082405365329645738338463660617839517748742382067894630709157440830272701/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 515008629725836864608373761366864636329667078238568134727564579373520773576589953185147936750893572329473126441906488707756511421304620614447199/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 5101097269957948127357310720877420568986536143823920552803682619934553268450403567526746835867611841711849762039459481896530418397016369842901/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 50516134039979274013710209301792126959459961048726470230340228484187406752024278459866129655228402441533835980196560423197276953505215856999/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 500162970100800747613234437391839666257171323724509800306466954385731381333578570301678077325539418601351878587844044678760373267729453101/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4951141112129300480941761993856966325830013370954644447540070246320519003369480508097758356823630490922746248362061057361215891593226799/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 49001425375043439201431939331888548745757710817723681288283537841621404074439197051492508654784146372957032811737990478396120117103301/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 484862882576196355570019589210995441876340513310340215033167048905266707822618152035277865199839862353101341532706974529253738556599/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4796594773496932884545652416272681231074146599094345606395626756618855634571900525608867325250907700536377187199060348780340793501/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 47440351247443766510562145618915972031051985849437834408036633905240966005776772985948154800514219197337143305041013624043846399/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 469094457044886530409718642615312848798504907570079135434713473790312787937139121070183381823375951488253972778192056808523701/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4637317747928146771815339824397099482813180884546253893279934078690028160981203243133165472963393449376302755335273301096199/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 45831492403314613856720604286839388715284655399457110033130647259495233949305083263971368413771651003801037932679528293901/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 452843357609238523805258629159993825406915711105627374072026739994901353023283669333044125391632838422232706390702305999/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4473165228376146705103622516767614398049653647531589637091179191867690434578622922556001266582149883052855620108104101/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 44173386145213603081854772896642569677269228762945349869607870624926166005844675985414154207900503869220763839475799/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 436094809547612152341967402996389592699689179423690402723311824494203697028734100862769234423237412820411755954301/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4303987975228405579211791949458480734340294741653438411346584085800037343724586877401709438618559725458704605599/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 42464525002307127062745373226853340750912068097509478902490748341414518623480675529310196349682421469279844501/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 418833585881890172350963365927811522736485536338479584873643922640550693166471469993032286360428499689695399/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 4129632180625153256070337029573853765015005417560399847208524471116673668348196666596285720812409087774701/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 40703355359850032889599363935089431969848539571317170173823479506229026953012087541376623442549586745199/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 401043993533838716056559231667570019897459995669870405796196762689182090434465530720975994369187744901/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 3949939328624633495520800319874444645428888845150206119153502653426081721560257886070464589587754999/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 38888276046713469651725255756307521670998877223739455749025279327536179005659170566368329187755101/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 382709859057711814663891472285934562333321992158984401505305851793294737430900712791599284724799/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 3764746051087998127918095679655904670033555476353377792982887391851461994251522351430295805301/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 37017636879676748766849451309655602727611671478316947403867549412641030244964872236669654599/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 363814513936128775422721730400561643713249206851686337412803529420616467120857295319895501/10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 3573883979152815913360825559601632764780295018703902398109126559804206738594518134544399/100000000000000000000000000000000000000000000000000000000000000000000000000000000000000 35089737163159756700614399591935684492730252714180832304132591513173805440348668025701/1000000000000000000000000000000000000000000000000000000000000000000000000000000000000 344340779425856128289034339312481661542729825395765982870026176900745509498471394199/10000000000000000000000000000000000000000000000000000000000000000000000000000000000 3377179590160162912010447871843249106492220458543090736060870473744904136348195901/100000000000000000000000000000000000000000000000000000000000000000000000000000000 33102824143031948606166140119628778853456772308516068041018893674190950872203999/1000000000000000000000000000000000000000000000000000000000000000000000000000000 324270950939716652587536768885139180337947195035515838798170643173645968406101/10000000000000000000000000000000000000000000000000000000000000000000000000000 3174454049896127803914512817021607882201486818540564028264349931046928973799/100000000000000000000000000000000000000000000000000000000000000000000000000 31055091413092200039540533505268766486883705237783475032973231626736656301/1000000000000000000000000000000000000000000000000000000000000000000000000 303586781950426263025661954598674408958421265028115909423972036633703599/10000000000000000000000000000000000000000000000000000000000000000000000 2965523050004305687127898531299741504630517828566827367918909460946501/100000000000000000000000000000000000000000000000000000000000000000000 28944677272770764516443419508078197016469877056230579473928378393399/1000000000000000000000000000000000000000000000000000000000000000000 282269467401724894105489085940183808247170475315460398726549276701/10000000000000000000000000000000000000000000000000000000000000000 2750196640421463576823122080203876850981519952681418168955043199/100000000000000000000000000000000000000000000000000000000000000 26769663034560238149728505860645220716985050027085032009646901/1000000000000000000000000000000000000000000000000000000000000 260299626611719577269984907683285057747323737647323555652999/10000000000000000000000000000000000000000000000000000000000 2528279056684036134040251592760455128760845834821450057101/100000000000000000000000000000000000000000000000000000000 24528071279636728626669208007681364936978240755772222799/1000000000000000000000000000000000000000000000000000000 237657285652896248754234424320013787242204452078507301/10000000000000000000000000000000000000000000000000000 2299568541948446957113479033535492800426307596752599/100000000000000000000000000000000000000000000000000 22217864060085322799126050843792856569962702997501/1000000000000000000000000000000000000000000000000 214321859192781038375010614583766227979421242399/10000000000000000000000000000000000000000000000 2063857163563444832070814288724911393731527701/100000000000000000000000000000000000000000000 19836941046095402344149639280049610037692199/1000000000000000000000000000000000000000000 190272131778741437819693326061107172097901/10000000000000000000000000000000000000000 1820930624027691291108013394556638101999/100000000000000000000000000000000000000 17383137616441326172808216106632708101/1000000000000000000000000000000000000 165486238549912385583921374814471799/10000000000000000000000000000000000 1570568066160731167514357321358301/100000000000000000000000000000000 14854222890512436035498558801599/1000000000000000000000000000000 139941645358711475106046048501/10000000000000000000000000000 1312541872310216920263091399/100000000000000000000000000 12247897700103201214778701/1000000000000000000000000 113615128283870719341199/10000000000000000000000 1046617457412835548901/100000000000000000000 9561792499119550999/1000000000000000000 86482752516359101/10000000000000000 772553055720799/100000000000000 6793465209301/1000000000000 58519850599/10000000000 490099501/100000000 3940399/1000000 29701/10000 199/100 1N)


(map twosf (dpvs 99/100 (repeat 100 1))) ; (63.4 63.03 62.65 62.28 61.9 61.51 61.12 60.73 60.33 59.93 59.53 59.12 58.71 58.29 57.87 57.44 57.01 56.58 56.14 55.7 55.25 54.8 54.34 53.88 53.41 52.94 52.47 51.99 51.5 51.01 50.52 50.02 49.51 49.0 48.49 47.97 47.44 46.91 46.37 45.83 45.28 44.73 44.17 43.61 43.04 42.46 41.88 41.3 40.7 40.1 39.5 38.89 38.27 37.65 37.02 36.38 35.74 35.09 34.43 33.77 33.1 32.43 31.74 31.06 30.36 29.66 28.94 28.23 27.5 26.77 26.03 25.28 24.53 23.77 23.0 22.22 21.43 20.64 19.84 19.03 18.21 17.38 16.55 15.71 14.85 13.99 13.13 12.25 11.36 10.47 9.56 8.65 7.73 6.79 5.85 4.9 3.94 2.97 1.99 1.0)


;; or we can throw precision to the wind
(reverse-dpvs 0.99 (repeat 100 1) 0 []) ; (63.39676587267702 63.027036235027296 62.653571954573025 62.27633530764952 61.89528818954497 61.51039211065149 61.12160819257726 60.72889716421946 60.332219357797435 59.931534704845895 59.52680273216757 59.117982557745016 58.70503288661113 58.28791200667791 57.86657778452314 57.440987661134486 57.011098647610595 56.576867320818785 56.13824981900888 55.695201837382704 55.247678623618896 54.79563497335242 54.33902522560851 53.87780325819041 53.41192248302062 52.94133584143497 52.465995799429265 51.98585434285784 51.500862972583676 51.01097269957947 50.51613403997926 50.016297010080066 49.511411121292994 49.00142537504343 48.48628825761963 47.96594773496932 47.44035124744376 46.90944570448865 46.37317747928146 45.831492403314606 45.284335760923845 44.73165228376146 44.1733861452136 43.60948095476121 43.03987975228405 42.46452500230712 41.88335858818901 41.29632180625153 40.70335535985003 40.10439935338387 39.49939328624633 38.888276046713464 38.27098590577118 37.647460510879974 37.01763687967674 36.38145139361287 35.73883979152815 35.08973716315975 34.4340779425856 33.77179590160162 33.10282414303194 32.42709509397166 31.744540498961268 31.05509141309219 30.358678195042614 29.655230500043047 28.944677272770754 28.22694674017248 27.501966404214627 26.76966303456023 26.02996266117195 25.282790566840355 24.528071279636723 23.76572856528962 22.995685419484467 22.21786406008532 21.4321859192781 20.638571635634445 19.8369410460954 19.027213177874142 18.209306240276913 17.383137616441328 16.54862385499124 15.705680661607312 14.854222890512437 13.994164535871148 13.12541872310217 12.247897700103202 11.361512828387072 10.466174574128356 9.561792499119552 8.64827525163591 7.72553055720799 6.793465209301 5.8519850599 4.90099501 3.9403989999999998 2.9701 1.99 1.0)
(reverse-dpvs 0.99 (repeat 500 1) 0 []) ; (99.34295169575849 99.33631484420049 99.32961095373787 99.32283934720996 99.31599934061613 99.3090902430466 99.30211135661273 99.29506197637649 99.28794139027929 99.28074887906999 99.27348371623232 99.26614516791143 99.25873249283983 99.25124494226245 99.24368175986106 99.23604218167785 99.22832543603823 99.22053074347296 99.21265731663935 99.20470436024176 99.19667107095128 99.18855663732452 99.18036023972174 99.17208105022398 99.16371823254947 99.15527094196916 99.14673832522138 99.13811952042563 99.1294136569956 99.12061985555111 99.11173722782941 99.10276487659536 99.09370189555086 99.0845473692433 99.07530037297303 99.06595997270003 99.05652522494952 99.04699517671669 99.0373688653704 99.02764531855595 99.01782355409692 99.00790257989588 98.99788139383423 98.98775898367094 98.97753432694034 98.96720639084883 98.95677413217054 98.94623649714195 98.93559242135551 98.92484082965203 98.91398063601216 98.90301074344663 98.89193004388548 98.88073741806615 98.86943173542035 98.85801185395995 98.84647662016157 98.83482486885006 98.82305542308087 98.81116709402109 98.79915868082938 98.78702897053472 98.77477673791385 98.76240074536753 98.74989974279549 98.73727246747019 98.72451764390928 98.71163398374675 98.69862018560278 98.6854749349523 98.67219690399222 98.65878475150728 98.64523712273463 98.6315526492269 98.61772994871404 98.60376762496368 98.58966426764009 98.57541845216171 98.56102873955729 98.5464936763205 98.53181179426312 98.51698161036678 98.50200162663312 98.48687032993244 98.47158619185096 98.45614766853632 98.44055320054174 98.42480121266843 98.40889011380649 98.39281829677424 98.37658413815579 98.36018599813717 98.34362222034058 98.32689113165715 98.30999104207793 98.29292024452316 98.27567701466985 98.25825961077763 98.24066627351276 98.22289522577046 ...)
(reverse-dpvs 0.99 (repeat 1000 1) 0 []) ; (99.99568287525882 99.9956392679382 99.9955952201396 99.99555072741374 99.9955057852664 99.99546038915798 99.99541453450301 99.99536821666972 99.99532143097952 99.99527417270659 99.99522643707736 99.99517821927006 99.9951295144142 99.99508031759011 99.9950306238284 99.9949804281095 99.99492972536314 99.99487851046781 99.99482677825031 99.99477452348516 99.99472174089411 99.99466842514556 99.99461457085411 99.99456017257991 99.99450522482819 99.99444972204867 99.99439365863502 99.99433702892426 99.99427982719622 99.99422204767295 99.99416368451813 99.9941047318365 99.99404518367324 99.99398503401338 99.99392427678119 99.99386290583958 99.99380091498948 99.99373829796917 99.99367504845371 99.99361116005426 99.99354662631744 99.9934814407247 99.9934155966916 99.99334908756728 99.99328190663361 99.99321404710466 99.99314550212591 99.99307626477365 99.9930063280542 99.99293568490323 99.99286432818508 99.992792250692 99.99271944514344 99.9926459041853 99.99257162038919 99.9924965862517 99.99242079419363 99.99234423655923 99.9922669056154 99.99218879355091 99.99210989247567 99.99203019441987 99.9919496913332 99.99186837508404 99.99178623745863 99.99170327016023 99.99161946480831 99.99153481293769 99.99144930599766 99.99136293535118 99.99127569227392 99.99118756795345 99.99109855348833 99.9910086398872 99.99091781806789 99.99082607885644 99.9907334129863 99.99063981109728 99.99054526373463 99.99044976134812 99.99035329429103 99.99025585281922 99.99015742709012 99.99005800716175 99.98995758299166 99.98985614443603 99.98975368124852 99.9896501830793 99.98954563947404 99.98944003987278 99.98933337360887 99.98922562990795 99.98911679788682 99.98900686655234 99.98889582480035 99.9887836614145 99.98867036506515 99.98855592430823 99.98844032758407 99.98832356321624 ...)
(reverse-dpvs 0.99 (repeat 10000 1) 0 []) ; (99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 ...)
(reverse-dpvs 0.99 (repeat 100000 1) 0 []) ; (99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 99.9999999999992 ...)

;; Meh, close enough for government work


;; and we can recover a nice definition of dpv itself, should we not be interested in the tail
(defn dpv [gamma sq] (first (dpvs gamma sq)))

;; the two calculations agree on random sequences to within the limits of floating point
(let [gamma (rand)
      sq (repeatedly 100 rand)]
  (list (- (dpv            gamma  sq)
           (dpv-definition gamma  sq)) gamma sq))
;; (4.440892098500626E-16 0.6349188601226116 (0.28115698809056333 0.2593541256394424 0.6723983751254319 0.5700415048918277 0.6019073389385662 0.04782081434714691 0.7156264804589626 0.7996266288858775 0.15295139724318318 0.5322303120318003 0.3175197387234172 0.2502297352042826 0.23641810509839656 0.3060227474445575 0.9251262396438946 0.45832851941244324 0.0012509877265236558 0.1747583406568768 0.6586221455668235 0.016617454336861015 0.2560707621102052 0.37230050544245696 0.8767630241792893 0.4392068953722631 0.6620092991711021 0.40105768032484745 0.8588330532551748 0.4939745967497742 0.8872108632884765 0.7149423421597437 0.32785431339154925 0.4927011123992686 0.2548910320480978 0.7342133789957327 0.4431382346952245 0.37825254053913426 0.5232898774072127 0.35812602404618255 0.4498319259548159 0.7029579458146351 0.6985508122166139 0.22432119445466314 0.3889321743777089 0.7534604141590334 0.20050161238385655 0.45314385868737384 0.14331040356529978 0.14470438490638915 0.27651023014815146 0.5105880642455186 0.6236120421833952 0.1793545178964786 0.29003242085722636 0.12532376280149982 0.082464271211106 0.14882382915371006 0.39816414784147525 0.9032688990285556 0.3862461641571162 0.5382220016583077 0.17645662957012043 0.39742725144797664 0.5707457360888274 0.7899175003699538 0.9494477023000112 0.911221178991245 0.16034864357067447 0.8790399443545069 0.9418078782333177 0.24030571073059104 0.5399738545016602 0.45913171127197927 0.8776952295529514 0.8908582853238678 0.13479111876853578 0.7472912372073771 0.32485835367401783 0.05159637960763408 0.2748267213397343 0.6355324989760017 0.9052222475195669 0.7422831879501234 0.39988288643409897 0.7387184535238698 0.4751365229890604 0.11323888900154888 0.69476754011406 0.21930907604083894 0.516161937764739 0.8283834438760399 0.33565092066284696 0.2652969209960273 0.27121501622983823 0.828594059492087 0.2754361057930397 0.04008684014897179 0.6110872420934678 0.5426689261817649 0.8993506663028762 0.7717082461220734))
;; (2.220446049250313E-16 0.6173548394271599 (0.3769580899510623 0.8854618833835283 0.88360317708551 0.9963135279522186 0.1818057930495962 0.36792958644283524 0.6588899226541285 0.7587647665768199 0.7805194015002976 0.9079224142491713 0.6486693491794665 0.33958207684640185 0.9088961679293583 0.5168175908325703 0.0013034630457405827 0.9138809077392298 0.842271764524662 0.5427524621102786 0.3445346953940801 0.6413772520537774 0.5489254364986369 0.9327162679518033 0.19759487670906195 0.37386302093136425 0.04934611737476968 0.1144510898543607 0.17470048571919516 0.40798182728205334 0.5012877980075418 0.10622465896160838 0.46714798114202527 0.7063094863349579 0.31667455619949936 0.5064831898932415 0.20547946571375575 0.5068135512524143 0.3087992108861124 0.21558742511738427 0.8236980741536455 0.3940866813180064 0.46689174779957254 0.09828079468230777 0.4742692538301163 0.715319068090573 0.46001690118598804 0.3082334524069036 0.875652423022742 0.6897952379879929 0.38339289960649914 0.6649517451510721 0.713365394759963 0.6827706954559399 0.577606197764378 0.2985375290014076 0.8610911611344136 0.892905037763401 0.574829841853241 0.7592273191431901 0.24009531932571448 0.13699717170005465 0.3560360723253938 0.9263365653700826 0.09322950175407452 0.5065898176987197 0.13932628898991428 0.34517962102665656 0.8140541820444986 0.41807996390787194 0.8618845575428385 0.0707312345870923 0.24212256975433866 0.9812927140582804 0.3666936193440453 0.7032405506391628 0.5122240280542497 0.6710459724415633 0.06003511590571142 0.06370470384718263 0.12839439425390964 0.002053997853746048 0.46692839654089346 0.8760529813659836 0.9227576405086342 0.27958803757591333 0.6790456018970983 0.8980894613789028 0.9547716849809298 0.5266323501923269 0.1632728003200008 0.1746859580647947 0.20820809544725538 0.372844761847806 0.7789705995750654 0.4744134552860386 0.15120449411349146 0.03145074588603447 0.13811945103380452 0.5147447756027901 0.8389852485879742 0.487270405508366))
;; (7.105427357601002E-15 0.9782604694933087 (0.3486240365940697 0.4246291000963198 0.8879249630986359 0.2634559639067593 0.603643439703814 0.7224728600775773 0.8359285611584159 0.38453509873031344 0.7587233119425889 0.6850838034812081 0.020951039496490353 0.625228479404904 0.9846948105237732 0.18972421765773517 0.9762816402574027 0.3750914948760772 0.5359962353417672 0.2841708787401298 0.18564585862971938 0.5125280255239186 0.9461988808299804 0.20045930721080019 0.1491712750399844 0.1411512417532551 0.8674050316060671 0.28820375344144133 0.11857044037386844 0.7897419966511943 0.39644434132506023 0.265350522982313 0.7922208936621234 0.7378220652960663 0.16536475726635225 0.3141050885721115 0.39851733922146326 0.08686829303002963 0.5645348590623963 0.5859063591815393 0.8898166735144154 0.5614509643048315 0.21374421029852975 0.6217042325732104 0.41949193260969764 0.7950874638378651 0.20000944575908064 0.04242922136347416 0.8810558671497943 0.03236067708188872 0.6603633248303521 0.6194259753440771 0.051010993240463876 0.7618586600679131 0.0037248532284188673 0.4957552394099094 0.7960279175577337 0.7837505370323712 0.4380185011189426 0.8966515295701047 0.8802489088318428 0.6113208991951469 0.4970314331860355 0.14105684741437607 0.1399592198250249 0.9075432806781016 0.9460669224855404 0.1460331919950072 0.1805638536164147 0.8657806108911004 0.7862738577054322 0.9019898084718903 0.29475294129146723 0.05795880901402206 0.07460124244480426 0.5890438429605035 9.340738598332399E-4 0.2940670030213455 0.9296476681904671 0.10346554653585693 0.4574550627143572 0.46359629429205784 0.40324590978200925 0.7680425952732562 0.02083646505515213 0.1625361799371955 0.863442952283056 0.9113303217820344 0.38517792589024047 0.14880587903099718 0.15660617953934675 0.8181377581725774 0.06509808735408595 0.3145056789553724 0.09470673497175786 0.27723232770874795 0.46601277062277957 0.9151310389623182 0.7484014278419507 0.5821283753046745 0.423252148690184 0.2539001409703481))
